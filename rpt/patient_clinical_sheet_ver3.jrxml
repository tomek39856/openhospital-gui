<?xml version="1.0" encoding="UTF-8"  ?>
<!-- Created with iReport - A designer for JasperReports -->
<!DOCTYPE jasperReport PUBLIC "//JasperReports//DTD Report Design//EN" "http://jasperreports.sourceforge.net/dtds/jasperreport.dtd">
<jasperReport
		 name="patient_clinical_sheet_ver3"
		 columnCount="1"
		 printOrder="Vertical"
		 orientation="Portrait"
		 pageWidth="595"
		 pageHeight="842"
		 columnWidth="535"
		 columnSpacing="0"
		 leftMargin="30"
		 rightMargin="30"
		 topMargin="20"
		 bottomMargin="20"
		 whenNoDataType="AllSectionsNoDetail"
		 isTitleNewPage="false"
		 isSummaryNewPage="false">
	<property name="ireport.scriptlethandling" value="0" />
	<property name="ireport.encoding" value="UTF-8" />
	<import value="java.util.*" />
	<import value="net.sf.jasperreports.engine.*" />
	<import value="net.sf.jasperreports.engine.data.*" />

	<parameter name="patientID" isForPrompting="true" class="java.lang.String"/>
	<parameter name="SUBREPORT_DIR" isForPrompting="true" class="java.lang.String">
		<defaultValueExpression ><![CDATA["./rpt/"]]></defaultValueExpression>
	</parameter>
	<parameter name="Type" isForPrompting="true" class="java.lang.String"/>
	<parameter name="Date_from" isForPrompting="true" class="java.lang.String"/>
	<parameter name="Date_to" isForPrompting="true" class="java.lang.String"/>
	<parameter name="Opd" isForPrompting="true" class="java.lang.Boolean"/>
	<parameter name="Admission" isForPrompting="true" class="java.lang.Boolean"/>
	<parameter name="Drugs" isForPrompting="true" class="java.lang.Boolean"/>
	<parameter name="Examination" isForPrompting="true" class="java.lang.Boolean"/>
	<parameter name="All" isForPrompting="true" class="java.lang.Boolean"/>
	<parameter name="Laboratory" isForPrompting="true" class="java.lang.Boolean"/>
	<parameter name="Operations" isForPrompting="true" class="java.lang.Boolean"/>
	<queryString><![CDATA[SELECT TYPE, DATE, IDS, NOTE, DETAILS_1, DETAILS_2, DETAILS_3, DETAILS_4
FROM (
SELECT CONCAT("Opd", " (", OPD_PROG_YEAR, ")") AS TYPE,
	   OPD_DATE AS DATE, OPD_ID AS IDS,
	   IF(OPD_NEW_PAT='N','New Attendance','Re-Attendance') AS DETAILS_1,
	   CONCAT((SELECT DIS_DESC FROM DISEASE WHERE DIS_ID_A = OPD_DIS_ID_A)) AS DETAILS_2,
	   CONCAT(" + ", (SELECT DIS_DESC FROM DISEASE WHERE DIS_ID_A = OPD_DIS_ID_A_2), " & ", (SELECT DIS_DESC FROM DISEASE WHERE DIS_ID_A = OPD_DIS_ID_A_3)) AS DETAILS_3,
	   "" AS DETAILS_4,
	   OPD_NOTE AS NOTE
	FROM 
		OPD 
		LEFT JOIN PATIENT ON (OPD_PAT_ID = PAT_ID) 
	WHERE OPD_PAT_ID = $P{patientID} AND (OPD_DATE BETWEEN $P{Date_from} AND $P{Date_to})
	
UNION

SELECT CONCAT("ADM", " (", ADM_YPROG, ")") AS TYPE,
	   ADM_DATE_ADM AS DATE, ADM_ID AS IDS,
	   WRD_NAME AS DETAILS_1,
	   (SELECT DIS_DESC FROM DISEASE WHERE DIS_ID_A = ADM_IN_DIS_ID_A) AS DETAILS_2,
	   CONCAT(DIST_DESC, " - ", (SELECT DIS_DESC FROM DISEASE WHERE DIS_ID_A = ADM_OUT_DIS_ID_A), " - ", DATE_FORMAT(ADM_DATE_DIS, '%d/%m/%Y')) AS DETAILS_3,
	   "" AS DETAILS_4,
	   ADM_NOTE AS NOTE
	FROM 
		ADMISSION  
		LEFT JOIN WARD ON (WRD_ID_A = ADM_WRD_ID_A) 
		LEFT JOIN ADMISSIONTYPE ON (ADMT_ID_A = ADM_ADMT_ID_A_ADM)
		LEFT JOIN DISCHARGETYPE ON (DIST_ID_A = ADM_DIST_ID_A)
	WHERE ADM_DELETED = 'N'
		AND ADM_PAT_ID = $P{patientID} AND (ADM_DATE_ADM BETWEEN $P{Date_from} AND $P{Date_to})

UNION
        SELECT "Examination" AS TYPE,
	PEX_DATE AS DATE, PEX_NOTE AS IDS, 
    CONCAT(" Height:  ", PEX_HEIGHT, " - Weight: " , PEX_WEIGHT) AS DETAILS_1,
       CONCAT(" AP:  ", PEX_AP_MIN, "/ " , PEX_AP_MAX) AS DETAILS_2,
	    CONCAT(" Temperature:  ", PEX_TEMP)  AS DETAILS_3,
	    CONCAT(" O:  ", PEX_SAT)  AS DETAILS_4,
	   PEX_NOTE AS NOTE
	FROM 
		PATIENTEXAMINATION
WHERE PEX_PAT_ID = $P{patientID} AND (PEX_DATE BETWEEN $P{Date_from} AND $P{Date_to})
UNION

SELECT "Drugs" AS TYPE,
	   MMVN_DATE AS DATE, MDSR_DESC AS IDS,
	   GROUP_CONCAT(CONCAT(MDSR_DESC, " - ", CAST(QTY AS CHAR), " ", MMVN_MDSR_UNITS) SEPARATOR '\n') AS DETAILS_1,
	   "" AS DETAILS_2,
	   "" AS DETAILS_3,
	   "" AS DETAILS_4,
	   "" AS NOTE
	FROM(
		SELECT MMVN_DATE,
		MDSR_DESC, SUM(MMVN_MDSR_QTY) AS QTY, MMVN_MDSR_UNITS
		FROM 
			MEDICALDSRSTOCKMOVWARD  
			LEFT JOIN MEDICALDSR ON (MMVN_MDSR_ID = MDSR_ID) 
		WHERE MMVN_PAT_ID = $P{patientID} AND (MMVN_DATE BETWEEN $P{Date_from} AND $P{Date_to})
		GROUP BY DATE(MMVN_DATE), MMVN_MDSR_ID
	) AS MEDICALS
GROUP BY DATE(DATE)

UNION

SELECT "Operations" AS TYPE,
	   OPER_OPDATE AS DATE, OPE_DESC AS IDS,
	   GROUP_CONCAT(CONCAT(OPE_DESC, " - ", OPER_RESULT)) AS DETAILS_1,
	   "" AS DETAILS_2,
	   "" AS DETAILS_3,
	   "" AS DETAILS_4,
	   "" AS NOTE
	FROM(
		SELECT OPER_OPDATE, OPE_DESC, OPER_RESULT
		FROM 
			OPERATIONROW  
			LEFT JOIN OPERATION ON (OPE_ID_A = OPER_ID_A)
			LEFT JOIN OPD ON (OPER_OPD_ID = OPD_ID) 
			LEFT JOIN ADMISSION ON (OPER_ADMISSION_ID = ADM_ID) 
		WHERE (OPD_PAT_ID = $P{patientID} OR ADM_PAT_ID = $P{patientID}) 
		  AND (OPER_OPDATE BETWEEN $P{Date_from} AND $P{Date_to})
		GROUP BY DATE(OPER_OPDATE)
	) AS OPERATIONS
GROUP BY DATE(DATE)
	
UNION

SELECT "Laboratory" AS TYPE,
	   LAB_DATE AS DATE, LAB_RES AS IDS,
	   EXA_DESC DETAILS_1,
	   LAB_RES AS DETAILS_2,
	   "" AS DETAILS_3,
	   "" AS DETAILS_4,
	   LAB_NOTE AS NOTE
	FROM 
		LABORATORY  
		LEFT JOIN EXAM ON (EXA_ID_A = LAB_EXA_ID_A) 
		LEFT JOIN LABORATORYROW ON LABR_LAB_ID = LAB_ID
	WHERE LAB_PAT_ID = $P{patientID} AND (LAB_DATE BETWEEN $P{Date_from} AND $P{Date_to})
    AND EXA_PROC = 1
    
UNION

SELECT "Laboratory" AS TYPE,
	   LAB_DATE AS DATE, LAB_ID AS IDS,
	   EXA_DESC DETAILS_1,
	   GROUP_CONCAT(LABR_DESC SEPARATOR ", " ) AS DETAILS_2,
	   "" AS DETAILS_3,
	   "" AS DETAILS_4,
	   LAB_NOTE AS NOTE
	FROM 
		LABORATORY  
		LEFT JOIN EXAM ON (EXA_ID_A = LAB_EXA_ID_A) 
		LEFT JOIN LABORATORYROW ON LABR_LAB_ID = LAB_ID
	WHERE LAB_PAT_ID = $P{patientID} AND (LAB_DATE BETWEEN $P{Date_from} AND $P{Date_to})
	AND EXA_PROC = 2
GROUP BY LABR_LAB_ID


    
) 
AS DETAILS

WHERE TYPE LIKE IF ($P!{Opd},'%Opd%','') 
   OR TYPE LIKE IF ($P!{Admission},'%ADM%','') 
   OR TYPE LIKE IF ($P!{Drugs},'%Drugs%','') 
   OR TYPE LIKE IF ($P!{Examination},'%Examination%','') 
   OR TYPE LIKE IF ($P!{Laboratory},'%Laboratory%','') 
   OR TYPE LIKE IF ($P!{Operations},'%Operations%','') 
   OR TYPE LIKE IF ($P!{All}, '%%','')
ORDER BY DATE DESC]]></queryString>

	<field name="TYPE" class="java.lang.String"/>
	<field name="DATE" class="java.sql.Timestamp"/>
	<field name="IDS" class="java.lang.String"/>
	<field name="NOTE" class="java.lang.String"/>
	<field name="DETAILS_1" class="java.lang.String"/>
	<field name="DETAILS_2" class="java.lang.String"/>
	<field name="DETAILS_3" class="java.lang.String"/>
	<field name="DETAILS_4" class="java.lang.String"/>


		<group  name="DATE" >
			<groupExpression><![CDATA[$F{DATE}]]></groupExpression>
			<groupHeader>
			<band height="0"  isSplitAllowed="true" >
			</band>
			</groupHeader>
			<groupFooter>
			<band height="0"  isSplitAllowed="true" >
			</band>
			</groupFooter>
		</group>
		<background>
			<band height="0"  isSplitAllowed="true" >
			</band>
		</background>
		<title>
			<band height="106"  isSplitAllowed="true" >
				<staticText>
					<reportElement
						x="0"
						y="0"
						width="164"
						height="21"
						key="staticText-1"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement verticalAlignment="Middle">
						<font pdfFontName="Helvetica-Bold" size="12" isBold="true"/>
					</textElement>
				<text><![CDATA[ PATIENT CLINICAL SHEET]]></text>
				</staticText>
				<staticText>
					<reportElement
						x="164"
						y="8"
						width="73"
						height="13"
						key="staticText-2"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement>
						<font size="7"/>
					</textElement>
				<text><![CDATA[version 2.0]]></text>
				</staticText>
				<staticText>
					<reportElement
						x="0"
						y="22"
						width="350"
						height="11"
						key="staticText-3"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement>
						<font size="7"/>
					</textElement>
				<text><![CDATA[this report list all the admissions and laboratory exams for the patient, more recent information as first]]></text>
				</staticText>
				<subreport  isUsingCache="true">
					<reportElement
						x="0"
						y="42"
						width="535"
						height="55"
						key="subreport-1"/>
					<parametersMapExpression><![CDATA[$P{REPORT_PARAMETERS_MAP}]]></parametersMapExpression>
					<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
					<subreportExpression  class="java.lang.String"><![CDATA[$P{SUBREPORT_DIR} + "patient_clinical_sheet_patsubreport.jasper"]]></subreportExpression>
				</subreport>
			</band>
		</title>
		<pageHeader>
			<band height="0"  isSplitAllowed="true" >
			</band>
		</pageHeader>
		<columnHeader>
			<band height="0"  isSplitAllowed="true" >
			</band>
		</columnHeader>
		<detail>
			<band height="89"  isSplitAllowed="true" >
				<textField isStretchWithOverflow="true" pattern="dd/MM/yyyy HH:mm" isBlankWhenNull="true" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="0"
						y="21"
						width="65"
						height="13"
						key="textField-1"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement textAlignment="Right">
						<font pdfFontName="Helvetica" isBold="false"/>
					</textElement>
				<textFieldExpression   class="java.sql.Timestamp"><![CDATA[$F{DATE}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="false" pattern="dd/MM/yyyy" isBlankWhenNull="false" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="0"
						y="8"
						width="65"
						height="13"
						key="textField-2"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement textAlignment="Right">
						<font pdfFontName="Helvetica-Bold" isBold="true"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA[$F{TYPE}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="true" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="75"
						y="60"
						width="460"
						height="13"
						key="textField-3"
						isRemoveLineWhenBlank="true"/>
					<box></box>
					<textElement>
						<font fontName="SansSerif" pdfFontName="Helvetica-Oblique" isItalic="true"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA[$F{NOTE}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="true" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="75"
						y="8"
						width="460"
						height="13"
						key="textField-4"
						stretchType="RelativeToBandHeight"/>
					<box></box>
					<textElement>
						<font fontName="SansSerif" pdfFontName="Helvetica" isBold="false"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA[$F{DETAILS_1}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="true" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="75"
						y="21"
						width="460"
						height="13"
						key="textField-5"
						isRemoveLineWhenBlank="true"/>
					<box></box>
					<textElement>
						<font fontName="SansSerif"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA[$F{DETAILS_2}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="true" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="75"
						y="34"
						width="460"
						height="13"
						key="textField-6"
						isRemoveLineWhenBlank="true"/>
					<box></box>
					<textElement>
						<font fontName="SansSerif"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA[$F{DETAILS_3}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="true" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="75"
						y="47"
						width="460"
						height="13"
						key="textField-7"
						isRemoveLineWhenBlank="true"/>
					<box></box>
					<textElement>
						<font fontName="SansSerif"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA[$F{DETAILS_4}]]></textFieldExpression>
				</textField>
				<subreport  isUsingCache="true">
					<reportElement
						x="75"
						y="76"
						width="460"
						height="10"
						key="subreport-2"/>
					<subreportParameter  name="id">
						<subreportParameterExpression><![CDATA[$F{IDS}]]></subreportParameterExpression>
					</subreportParameter>
					<subreportParameter  name="type">
						<subreportParameterExpression><![CDATA[$F{TYPE}]]></subreportParameterExpression>
					</subreportParameter>
					<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
					<subreportExpression  class="java.lang.String"><![CDATA[$P{SUBREPORT_DIR} + "patient_clinical_sheet_ver3_subreport_Operation.jasper"]]></subreportExpression>
				</subreport>
			</band>
		</detail>
		<columnFooter>
			<band height="0"  isSplitAllowed="true" >
			</band>
		</columnFooter>
		<pageFooter>
			<band height="14"  isSplitAllowed="true" >
				<textField isStretchWithOverflow="false" pattern="dd/MM/yyyy" isBlankWhenNull="false" evaluationTime="Report" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="0"
						y="0"
						width="100"
						height="14"
						key="textField-8"/>
					<box leftPadding="2">					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement>
						<font size="8"/>
					</textElement>
				<textFieldExpression   class="java.util.Date"><![CDATA[new java.util.Date()]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="false" isBlankWhenNull="false" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="328"
						y="0"
						width="150"
						height="14"
						key="textField-9"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement textAlignment="Right">
						<font size="8"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA["Page " + $V{PAGE_NUMBER} + " of "]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="false" isBlankWhenNull="false" evaluationTime="Report" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						x="485"
						y="0"
						width="43"
						height="14"
						key="textField-10"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement>
						<font size="8"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA["" + $V{PAGE_NUMBER} + ""]]></textFieldExpression>
				</textField>
			</band>
		</pageFooter>
		<lastPageFooter>
			<band height="14"  isSplitAllowed="true" >
				<textField isStretchWithOverflow="false" pattern="dd/MM/yyyy" isBlankWhenNull="false" evaluationTime="Report" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						mode="Opaque"
						x="0"
						y="0"
						width="100"
						height="14"
						key="textField-11"/>
					<box leftPadding="2">					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement>
						<font size="8"/>
					</textElement>
				<textFieldExpression   class="java.util.Date"><![CDATA[new java.util.Date()]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="false" isBlankWhenNull="false" evaluationTime="Now" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						mode="Opaque"
						x="328"
						y="0"
						width="150"
						height="14"
						key="textField-12"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement textAlignment="Right">
						<font size="8"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA["Page " + $V{PAGE_NUMBER} + " of "]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="false" isBlankWhenNull="false" evaluationTime="Report" hyperlinkType="None"  hyperlinkTarget="Self" >
					<reportElement
						mode="Opaque"
						x="485"
						y="0"
						width="43"
						height="14"
						key="textField-13"/>
					<box>					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
</box>
					<textElement>
						<font size="8"/>
					</textElement>
				<textFieldExpression   class="java.lang.String"><![CDATA["" + $V{PAGE_NUMBER} + ""]]></textFieldExpression>
				</textField>
			</band>
		</lastPageFooter>
		<summary>
			<band height="0"  isSplitAllowed="true" >
			</band>
		</summary>
</jasperReport>
